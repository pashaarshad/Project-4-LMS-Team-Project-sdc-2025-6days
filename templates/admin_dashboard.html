<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Admin Dashboard</title>
</head>
<body class="admin-body">
    <div id="top-header">
        <h2>Welcome to LMS</h2>
        <div class="header-right">
            <p id="admin-name">{{ fullname }}</p>
            <a href="{{ url_for('admin_dashboard') }}" class="header-icon">üè†</a>
        </div>
    </div>
    <div class="main-wrapper">
        <button id="toggle-sidebar" class="toggle-btn">
            <span class="arrow">‚óÄ</span>
        </button>
        <!-- Left Panel -->
        <div id="left-panel">
            <div class="nav-section">
                <div class="nav-section-header">
                    <span>DASHBOARD</span>
                </div>
                <div class="nav-item active">
                    <span class="nav-icon">üìä</span>
                    <span>MIS</span>
                </div>
                <div class="nav-section-header">
                    <span>MAIN NAVIGATION</span>
                </div>
                <div class="nav-item has-submenu">
                    <span>
                        <span class="nav-icon">üìñ</span>
                        <span>Library</span>
                    </span>
                    <ul class="sub-menu">
                        <li>Manage Members</li>
                        <li>Manage Books</li>
                        <li>Issue/Return Books</li>
                        <li>Reports</li>
                    </ul>
                </div>
                <div class="nav-section-header">
                    <span>SETTING MASTER</span>
                </div>
            </div>
            <div id="logout-container">
                <a href="{{ url_for('logout') }}" class="auth-button">Logout</a>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <div id="member-management" style="display: none;">
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <h3>Total Members</h3>
                            <p id="total-members">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìö</div>
                        <div class="stat-info">
                            <h3>Books Borrowed</h3>
                            <p id="books-borrowed">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚åõ</div>
                        <div class="stat-info">
                            <h3>Due Returns</h3>
                            <p id="due-returns">0</p>
                        </div>
                    </div>
                </div>
                <div class="page-header">
                    <div class="search-section">
                        <input type="text" id="search-input" placeholder="Search by Name, Email or Phone">
                        <button class="member-btn">Member</button>
                        <button class="excel-btn">Excel</button>
                    </div>
                </div>
                <div class="member-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="members-table-body">
                            <!-- Data will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Update Member Modal -->
                <div class="member-modal" id="memberModal">
                    <div class="modal-content">
                        <span class="close-btn">&times;</span>
                        <h2>Add New Member</h2>
                        <form id="memberForm">
                            <div class="form-group">
                                <label>Full Name:</label>
                                <input type="text" id="member-name" required>
                            </div>
                            <div class="form-group">
                                <label>Email:</label>
                                <input type="email" id="member-email" required>
                            </div>
                            <div class="form-group">
                                <label>Phone Number:</label>
                                <input type="tel" id="member-phone" required>
                            </div>
                            <div class="button-group">
                                <button type="submit" class="submit-btn">Add Member</button>
                                <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div id="book-management" style="display: none;">
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">üìö</div>
                        <div class="stat-info">
                            <h3>Total Books</h3>
                            <p id="total-books">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìñ</div>
                        <div class="stat-info">
                            <h3>Books Borrowed</h3>
                            <p id="books-out">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚åõ</div>
                        <div class="stat-info">
                            <h3>Due Returns</h3>
                            <p id="books-due">0</p>
                        </div>
                    </div>
                </div>
                <div class="page-header">
                    <div class="search-section">
                        <input type="text" id="book-search" placeholder="Search by Title, Author or Code">
                        <button class="book-btn">Add Book</button>
                        <button class="excel-btn">Excel</button>
                    </div>
                </div>
                <div class="book-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Category</th>
                                <th>Available</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="books-table-body">
                            <!-- Books will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="circulation-management" style="display: none;">
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">üìö</div>
                        <div class="stat-info">
                            <h3>Under Circulation</h3>
                            <p id="under-circulation">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-info">
                            <h3>Due Today</h3>
                            <p id="due-today">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <div class="stat-info">
                            <h3>Due Date Lapsed</h3>
                            <p id="due-lapsed">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-info">
                            <h3>Members Borrowed</h3>
                            <p id="members-borrowed">0</p>
                        </div>
                    </div>
                </div>
                <div class="page-header">
                    <div class="search-section">
                        <input type="text" id="issue-search" placeholder="Search by USID, Name or Book">
                        <button class="issue-btn">Issue Book</button>
                        <button class="excel-btn">Excel</button>
                    </div>
                </div>
                <div class="issue-table">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Username</th>
                                <th>Name</th>
                                <th>Book Code</th>
                                <th>Book Title</th>
                                <th>Issued Date</th>
                                <th>Due Date</th>
                                <th>Due Days</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="issues-table-body">
                            <!-- Issues will be loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add Book Modal -->
            <div class="book-modal" id="bookModal">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h2>Add New Book</h2>
                    <form id="bookForm">
                        <div class="form-group">
                            <label>Title:</label>
                            <input type="text" id="book-title" required>
                        </div>
                        <div class="form-group">
                            <label>Author:</label>
                            <input type="text" id="book-author" required>
                        </div>
                        <div class="form-group">
                            <label>Category:</label>
                            <select id="book-category" required>
                                <option value="Programming">Programming</option>
                                <option value="Software Engineering">Software Engineering</option>
                                <option value="Database">Database</option>
                                <option value="Networking">Networking</option>
                                <option value="AI">AI</option>
                                <option value="Web Development">Web Development</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Computer Architecture">Computer Architecture</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Available:</label>
                            <input type="number" id="book-available" min="0" value="1" required>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="submit-btn">Add Book</button>
                            <button type="button" class="cancel-btn" onclick="closeBookModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Add Edit Book Modal -->
            <div class="book-modal" id="editBookModal">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h2>Edit Book</h2>
                    <form id="editBookForm">
                        <input type="hidden" id="edit-book-id">
                        <div class="form-group">
                            <label>Title:</label>
                            <input type="text" id="edit-book-title" required>
                        </div>
                        <div class="form-group">
                            <label>Author:</label>
                            <input type="text" id="edit-book-author" required>
                        </div>
                        <div class="form-group">
                            <label>Category:</label>
                            <select id="edit-book-category" required>
                                <option value="Programming">Programming</option>
                                <option value="Software Engineering">Software Engineering</option>
                                <option value="Database">Database</option>
                                <option value="Networking">Networking</option>
                                <option value="AI">AI</option>
                                <option value="Web Development">Web Development</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Computer Architecture">Computer Architecture</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Available:</label>
                            <input type="number" id="edit-book-available" min="0" required>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="submit-btn">Update Book</button>
                            <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Issue Book Modal -->
            <div class="issue-modal" id="issueModal">
                <div class="modal-content">
                    <div class="issue-header">
                        <h2>Book Issue</h2>
                        <div class="issue-date">Issue Date: <span id="current-date"></span> <span id="current-time"></span></div>
                        <span class="close-btn">&times;</span>
                    </div>
                    
                    <form id="issueForm" class="issue-form">
                        <!-- Username search section -->
                        <div class="form-section">
                            <label>Enter Username:</label>
                            <div class="search-container">
                                <input 
                                    type="text" 
                                    id="member-username" 
                                    placeholder="Enter exact username"
                                    autocomplete="off"
                                >
                                <div class="validation-message" id="username-validation"></div>
                            </div>
                            <div class="selected-item" id="selected-member">
                                <div class="selected-info"></div>
                            </div>
                        </div>

                        <!-- Book code section -->
                        <div class="form-section">
                            <label>Enter Book Code:</label>
                            <div class="search-container">
                                <input 
                                    type="text" 
                                    id="book-code-input" 
                                    placeholder="Enter exact book code"
                                    autocomplete="off"
                                >
                                <div class="validation-message" id="book-validation"></div>
                            </div>
                            <div class="selected-item" id="selected-book">
                                <div class="selected-info"></div>
                            </div>
                        </div>

                        <!-- Due date section -->
                        <div class="form-section">
                            <label>Due Date:</label>
                            <input type="date" id="due-date" required>
                        </div>

                        <div class="button-group">
                            <button type="submit" class="submit-btn" id="issue-submit-btn" disabled>Issue Book</button>
                            <button type="button" class="cancel-btn">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Issue Book Modal (Simple Example) -->
            <div class="issue-modal" id="issueModalSimple">
                <div class="modal-content">
                    <h2>Issue Book</h2>
                    <form action="/issue" method="POST">
                        <label>Search Member:</label><br>
                        <input type="text" id="memberSearch" onkeyup="searchMembers()" placeholder="Enter member name">
                        <select name="member_id" id="memberList" required></select><br><br>

                        <label>Search Book:</label><br>
                        <input type="text" id="bookSearch" onkeyup="searchBooks()" placeholder="Enter book title">
                        <select name="book_id" id="bookList" required></select><br><br>

                        <label>Due Date:</label>
                        <input type="date" name="due_date" required><br><br>

                        <button type="submit">Issue Book</button>
                        <button type="button" onclick="document.getElementById('issueModalSimple').style.display='none'">Cancel</button>
                    </form>
                </div>
            </div>

            <img src="{{ url_for('static', filename='logobg.png') }}" alt="LMS Logo" class="center-logo" id="default-content">
        </div>
    </div>
    <div class="member-modal" id="memberModal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Add New Member</h2>
            <form id="memberForm">
                <div class="form-group">
                    <label>Full Name:</label>
                    <input type="text" id="member-name" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="member-email" required>
                </div>
                <div class="form-group">
                    <label>Phone Number:</label>
                    <input type="tel" id="member-phone" required>
                </div>
                <div class="button-group">
                    <button type="submit" class="submit-btn">Add Member</button>
                    <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const libraryItem = document.querySelector('.nav-item.has-submenu');
            libraryItem.addEventListener('click', function(e) {
                e.preventDefault();
                this.classList.toggle('active');
                const subMenu = this.querySelector('.sub-menu');
                if (this.classList.contains('active')) {
                    subMenu.style.display = 'block';
                } else {
                    subMenu.style.display = 'none';
                }
            });
        });

        // Add sidebar toggle functionality
        document.getElementById('toggle-sidebar').addEventListener('click', function() {
            const leftPanel = document.getElementById('left-panel');
            const mainContent = document.getElementById('main-content');
            const toggleBtn = document.getElementById('toggle-sidebar');
            const arrow = toggleBtn.querySelector('.arrow');
            
            leftPanel.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            toggleBtn.classList.toggle('moved');
            
            if (leftPanel.classList.contains('collapsed')) {
                arrow.textContent = '‚ñ∂';
            } else {
                arrow.textContent = '‚óÄ';
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const memberManagement = document.getElementById('member-management');
            const defaultContent = document.getElementById('default-content');
            
            // Add click handler for Manage Members
            document.querySelector('.sub-menu li:first-child').addEventListener('click', function() {
                memberManagement.style.display = 'block';
                document.getElementById('book-management').style.display = 'none';
                document.getElementById('circulation-management').style.display = 'none';
                defaultContent.style.display = 'none';
                loadMembers(); // Add this line
                loadStats(); // Add this line
            });
        });

        // Add this to your existing JavaScript
        function loadMembers() {
            fetch('/admin/get-members')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('members-table-body');
                    const totalMembers = document.getElementById('total-members');
                    tableBody.innerHTML = '';
                    
                    // Update total members count
                    totalMembers.textContent = data.members.length;
                    
                    data.members.forEach((member) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${member.id}</td>
                            <td>${member.fullname}</td>
                            <td>${member.email}</td>
                            <td>${member.phone || '-'}</td>
                            <td class="action-buttons">
                                <button onclick="editMember(${member.id})" class="edit-btn">‚úèÔ∏è</button>
                                <button onclick="deleteMember(${member.id})" class="delete-btn">üóëÔ∏è</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error loading members:', error));
        }

        function editMember(id) {
            fetch(`/admin/edit-member/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const member = data.member;
                        document.getElementById('member-name').value = member.fullname;
                        document.getElementById('member-email').value = member.email;
                        document.getElementById('member-phone').value = member.phone || '';
                        
                        // Update form for editing
                        const form = document.getElementById('memberForm');
                        form.dataset.mode = 'edit';
                        form.dataset.memberId = member.id;
                        
                        // Update modal title and button
                        document.querySelector('#memberModal h2').textContent = 'Edit Member';
                        document.querySelector('#memberModal .submit-btn').textContent = 'Update Member';
                        
                        // Show modal
                        document.getElementById('memberModal').style.display = 'block';
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function deleteMember(id) {
            if (confirm('Are you sure you want to delete this member?')) {
                fetch(`/admin/delete-member/${id}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadMembers();  // Reload the table
                            loadStats();    // Update the stats
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // Update the member form submission handler
        document.getElementById('memberForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const isEdit = form.dataset.mode === 'edit';
            
            const formData = {
                fullname: document.getElementById('member-name').value,
                email: document.getElementById('member-email').value,
                phone: document.getElementById('member-phone').value
            };
            
            if (isEdit) {
                formData.id = form.dataset.memberId;
            }
            
            const url = isEdit ? '/admin/update-member' : '/admin/add-member';
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    document.getElementById('memberModal').style.display = 'none';
                    form.reset();
                    loadMembers();
                    loadStats();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // Reset form when opening add member modal
        document.querySelector('.member-btn').addEventListener('click', () => {
            const form = document.getElementById('memberForm');
            form.reset();
            form.dataset.mode = 'add';
            delete form.dataset.memberId;
            
            document.querySelector('#memberModal h2').textContent = 'Add New Member';
            document.querySelector('#memberModal .submit-btn').textContent = 'Add Member';
            
            document.getElementById('memberModal').style.display = 'block';
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('memberModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Member Modal functionality
        const memberBtn = document.querySelector('.member-btn');
        const memberModal = document.getElementById('memberModal');
        const modalContent = memberModal.querySelector('.modal-content');
        const closeBtn = document.querySelector('.close-btn');
        const cancelBtn = document.querySelector('.cancel-btn');

        function closeModal() {
            const modal = document.getElementById('memberModal');
            modal.style.display = 'none';
            document.getElementById('memberForm').reset();
        }

        memberBtn.addEventListener('click', () => {
            memberModal.style.display = 'block';
        });

        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        // Add Excel export functionality
        document.querySelector('.excel-btn').addEventListener('click', function() {
            window.location.href = '/admin/export-members';
        });

        // Add Excel export functionality for books
        document.querySelector('#book-management .excel-btn').addEventListener('click', function() {
            window.location.href = '/admin/export-books';
        });

        function loadStats() {
            fetch('/admin/get-stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-members').textContent = data.total_members;
                    document.getElementById('books-borrowed').textContent = data.books_borrowed;
                    document.getElementById('due-returns').textContent = data.due_returns;
                })
                .catch(error => console.error('Error loading stats:', error));
        }

        // Update loadBookStats function to show correct counts
        function loadBookStats() {
            fetch('/admin/get-book-stats')
                .then(response => response.json())
                .then(data => {
                    // Update the stats in the UI
                    document.getElementById('total-books').textContent = data.total_titles;
                    document.getElementById('books-out').textContent = data.books_borrowed;
                    document.getElementById('books-due').textContent = data.due_returns;
                })
                .catch(error => {
                    console.error('Error loading book stats:', error);
                    document.getElementById('total-books').textContent = '0';
                    document.getElementById('books-out').textContent = '0';
                    document.getElementById('books-due').textContent = '0';
                });
        }

        // Ensure both book and member stats are loaded when switching tabs
        document.querySelector('.sub-menu li:first-child').addEventListener('click', function() {
            // ...existing code...
            loadMembers();
            loadStats();
        });

        document.querySelector('.sub-menu li:nth-child(2)').addEventListener('click', function() {
            // ...existing code...
            loadBooks();
            loadBookStats();
        });

        document.getElementById('search-input').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const tableBody = document.getElementById('members-table-body');
            const rows = tableBody.getElementsByTagName('tr');

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });

        // Update click handler for Manage Books
        document.querySelector('.sub-menu li:nth-child(2)').addEventListener('click', function() {
            document.getElementById('member-management').style.display = 'none';
            document.getElementById('book-management').style.display = 'block';
            document.getElementById('circulation-management').style.display = 'none';
            document.getElementById('default-content').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            loadBooks();
            loadBookStats();
        });

        function loadBooks() {
            fetch('/admin/books')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('books-table-body');
                    const totalBooks = document.getElementById('total-books');
                    tableBody.innerHTML = '';
                    
                    // Update total books count
                    totalBooks.textContent = data.books.length;
                    
                    data.books.forEach((book) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${book.book_id}</td>
                            <td>${book.title}</td>
                            <td>${book.author}</td>
                            <td>${book.category}</td>
                            <td>${book.available}</td>
                            <td class="action-buttons">
                                <button onclick="editBook(${book.book_id})" class="edit-btn">‚úèÔ∏è</button>
                                <button onclick="deleteBook(${book.book_id})" class="delete-btn">üóëÔ∏è</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error loading books:', error));
        }

        // Book search functionality
        document.getElementById('book-search').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const tableBody = document.getElementById('books-table-body');
            const rows = tableBody.getElementsByTagName('tr');

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });

        // Book modal functionality
        const bookBtn = document.querySelector('.book-btn');
        const bookModal = document.getElementById('bookModal');
        const bookCloseBtn = bookModal.querySelector('.close-btn');
        const bookCancelBtn = bookModal.querySelector('.cancel-btn');

        function closeBookModal() {
            bookModal.style.display = 'none';
            document.getElementById('bookForm').reset();
        }

        bookBtn.addEventListener('click', () => {
            bookModal.style.display = 'block';
        });

        bookCloseBtn.addEventListener('click', closeBookModal);
        bookCancelBtn.addEventListener('click', closeBookModal);

        // Close modal when clicking outside
        bookModal.addEventListener('click', (e) => {
            if (e.target === bookModal) {
                closeBookModal();
            }
        });

        // Add book form submission
        document.getElementById('bookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                title: document.getElementById('book-title').value,
                author: document.getElementById('book-author').value,
                category: document.getElementById('book-category').value,
                available: parseInt(document.getElementById('book-available').value)
            };

            try {
                const response = await fetch('/admin/add-book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    closeBookModal();
                    loadBooks();
                    loadBookStats();  // Reload stats after adding a book
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        function loadBookStats() {
            fetch('/admin/get-book-stats')
                .then(response => response.json())
                .then(data => {
                    // Update the stats in the UI
                    document.getElementById('total-books').textContent = data.total_titles;
                    document.getElementById('books-out').textContent = data.books_borrowed;
                    document.getElementById('books-due').textContent = data.due_returns;
                })
                .catch(error => {
                    console.error('Error loading book stats:', error);
                    document.getElementById('total-books').textContent = '0';
                    document.getElementById('books-out').textContent = '0';
                    document.getElementById('books-due').textContent = '0';
                });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Add this line to load book stats on page load if book management is visible
            if (document.getElementById('book-management').style.display === 'block') {
                loadBookStats();
            }
        });

        function editBook(id) {
            fetch(`/admin/get-book/${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('edit-book-id').value = data.id;
                    document.getElementById('edit-book-title').value = data.title;
                    document.getElementById('edit-book-author').value = data.author;
                    document.getElementById('edit-book-category').value = data.category;
                    document.getElementById('edit-book-available').value = data.available;
                    document.getElementById('editBookModal').style.display = 'block';
                });
        }

        document.getElementById('editBookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                id: document.getElementById('edit-book-id').value,
                title: document.getElementById('edit-book-title').value,
                author: document.getElementById('edit-book-author').value,
                category: document.getElementById('edit-book-category').value,
                available: document.getElementById('edit-book-available').value
            };

            try {
                const response = await fetch('/admin/update-book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    document.getElementById('editBookModal').style.display = 'none';
                    loadBooks();
                    loadBookStats();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        function deleteBook(id) {
            if (confirm('Are you sure you want to delete this book?')) {
                fetch(`/admin/delete-book/${id}`, { method: 'POST' })
                    .then(response => response.json())
                    .then((data) => {
                        if (data.success) {
                            loadBooks();
                            loadBookStats();
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // Add click handler for Issue/Return Books
        document.querySelector('.sub-menu li:nth-child(3)').addEventListener('click', function() {
            document.getElementById('member-management').style.display = 'none';
            document.getElementById('book-management').style.display = 'none';
            document.getElementById('circulation-management').style.display = 'block';
            document.getElementById('default-content').style.display = 'none';
            loadCirculationStats();
            loadIssuedBooks();
        });

        function loadCirculationStats() {
            fetch('/admin/get-circulation-stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('under-circulation').textContent = data.under_circulation;
                    document.getElementById('due-today').textContent = data.due_today;
                    document.getElementById('due-lapsed').textContent = data.overdue;
                    document.getElementById('members-borrowed').textContent = data.members_borrowed;
                })
                .catch(error => console.error('Error loading circulation stats:', error));
        }

        function loadIssuedBooks() {
            fetch('/admin/get-issued-books')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('issues-table-body');
                    tableBody.innerHTML = '';
                    
                    data.issues.forEach((issue, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${issue.user_id}</td>
                            <td>${issue.member_name}</td>
                            <td>${issue.book_code}</td>
                            <td>${issue.book_title}</td>
                            <td>${new Date(issue.issued_date).toLocaleDateString()}</td>
                            <td>${new Date(issue.due_date).toLocaleDateString()}</td>
                            <td>${issue.due_days > 0 ? issue.due_days : 0}</td>
                            <td>
                                <button onclick="returnBook(${issue.id})" class="return-btn">Return</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error loading issued books:', error));
        }

        // Issue book functionality
        function setupIssueForm() {
            const issueModal = document.getElementById('issueModal');
            const issueBtn = document.querySelector('.issue-btn');
            const closeBtn = issueModal.querySelector('.close-btn');
            const cancelBtn = issueModal.querySelector('.cancel-btn');

            issueBtn.addEventListener('click', () => {
                issueModal.style.display = 'block';
            });

            closeBtn.addEventListener('click', () => {
                issueModal.style.display = 'none';
            });

            cancelBtn.addEventListener('click', () => {
                issueModal.style.display = 'none';
            });

            // Auto-fill member details on USID input
            document.getElementById('issue-usid').addEventListener('change', async function() {
                const usid = this.value;
                try {
                    const response = await fetch(`/admin/get-member-by-usid/${usid}`);
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('issue-name').value = data.member.fullname;
                    }
                } catch (error) {
                    console.error('Error fetching member details:', error);
                }
            });

            // Auto-fill book details on book code input
            document.getElementById('issue-book-code').addEventListener('change', async function() {
                const bookCode = this.value;
                try {
                    const response = await fetch(`/admin/get-book-by-code/${bookCode}`);
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('issue-book-title').value = data.book.title;
                    }
                } catch (error) {
                    console.error('Error fetching book details:', error);
                }
            });
        }

        setupIssueForm();

        // Search functionality for issued books
        document.getElementById('issue-search').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const tableBody = document.getElementById('issues-table-body');
            const rows = tableBody.getElementsByTagName('tr');

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });

        function returnBook(issueId) {
            if (confirm('Are you sure you want to return this book?')) {
                fetch(`/admin/return-book/${issueId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadIssuedBooks();
                            loadCirculationStats();
                        }
                    })
                    .catch(error => console.error('Error returning book:', error));
            }
        }

        let searchTimeout;

        document.getElementById('member-search').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const searchTerm = e.target.value;
            const resultsDiv = document.getElementById('member-search-results');
            
            if (searchTerm.length < 3) {
                resultsDiv.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`/admin/search-members/${searchTerm}`)
                    .then(response => response.json())
                    .then(data => {
                        resultsDiv.innerHTML = '';
                        data.members.forEach(member => {
                            const div = document.createElement('div');
                            div.className = 'search-result-item';
                            div.textContent = `${member.fullname} (${member.username})`;
                            div.addEventListener('click', () => {
                                document.getElementById('selected-member').value = member.fullname;
                                document.getElementById('selected-member-id').value = member.username;
                                resultsDiv.style.display = 'none';
                            });
                            resultsDiv.appendChild(div);
                        });
                        resultsDiv.style.display = 'block';
                    });
            }, 300);
        });

        document.getElementById('book-search').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const searchTerm = e.target.value;
            const resultsDiv = document.getElementById('book-search-results');
            
            if (searchTerm.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`/admin/search-books/${searchTerm}`)
                    .then(response => response.json())
                    .then(data => {
                        resultsDiv.innerHTML = '';
                        data.books.forEach(book => {
                            const div = document.createElement('div');
                            div.className = 'search-result-item';
                            div.textContent = `${book.title} (${book.book_code}) - Available: ${book.available}`;
                            div.addEventListener('click', () => {
                                document.getElementById('selected-book').value = book.title;
                                document.getElementById('selected-book-code').value = book.book_code;
                                resultsDiv.style.display = 'none';
                            });
                            resultsDiv.appendChild(div);
                        });
                        resultsDiv.style.display = 'block';
                    });
            }, 300);
        });

        // Set minimum date for due date input
        document.getElementById('issue-due-date').min = new Date().toISOString().split('T')[0];

        // Submit issue form
        document.getElementById('issueForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                user_id: document.getElementById('selected-member-id').value,
                username: document.getElementById('selected-member-id').value,
                member_name: document.getElementById('selected-member').value,
                book_code: document.getElementById('selected-book-code').value,
                book_title: document.getElementById('selected-book').value,
                due_date: document.getElementById('issue-due-date').value
            };

            try {
                const response = await fetch('/admin/issue-book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    document.getElementById('issueModal').style.display = 'none';
                    document.getElementById('issueForm').reset();
                    loadIssuedBooks();
                    loadCirculationStats();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to issue book');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to issue book');
            }
        });

        // Set current date in issue modal
        function updateCurrentDate() {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('current-date').textContent = formattedDate;
        }

        // Update member search functionality
        document.getElementById('member-search').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const searchTerm = e.target.value;
            const resultsDiv = document.getElementById('member-search-results');
            
            if (searchTerm.length < 3) {
                resultsDiv.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`/admin/search-members/${searchTerm}`)
                    .then(response => response.json())
                    .then(data => {
                        resultsDiv.innerHTML = '';
                        if (data.members.length === 0) {
                            const div = document.createElement('div');
                            div.className = 'search-result-item';
                            div.textContent = 'No members found';
                            resultsDiv.appendChild(div);
                        } else {
                            data.members.forEach(member => {
                                const div = document.createElement('div');
                                div.className = 'search-result-item';
                                div.innerHTML = `
                                    <div><strong>${member.username}</strong></div>
                                    <div>${member.fullname}</div>
                                `;
                                div.addEventListener('click', () => {
                                    document.getElementById('selected-member').value = 
                                        `${member.username} - ${member.fullname}`;
                                    document.getElementById('selected-member-id').value = member.username;
                                    resultsDiv.style.display = 'none';
                                });
                                resultsDiv.appendChild(div);
                            });
                        }
                        resultsDiv.style.display = 'block';
                    });
            }, 300);
        });

        // Initialize issue modal
        function setupIssueModal() {
            const issueBtn = document.querySelector('.issue-btn');
            const issueModal = document.getElementById('issueModal');
            const closeBtn = issueModal.querySelector('.close-btn');
            const cancelBtn = issueModal.querySelector('.cancel-btn');

            issueBtn.addEventListener('click', () => {
                issueModal.style.display = 'block';
                updateCurrentDate();
            });

            [closeBtn, cancelBtn].forEach(btn => {
                btn.addEventListener('click', () => {
                    issueModal.style.display = 'none';
                    document.getElementById('issueForm').reset();
                });
            });
        }

        // Call setup function when DOM is loaded
        document.addEventListener('DOMContentLoaded', setupIssueModal);

        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('en-GB', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('current-date').textContent = dateStr;
            document.getElementById('current-time').textContent = timeStr;
        }

        // Username validation
        document.getElementById('member-username').addEventListener('input', async function(e) {
            const username = this.value.trim();
            const validationDiv = document.getElementById('username-validation');
            const selectedMemberInfo = document.querySelector('#selected-member .selected-info');
            const submitBtn = document.getElementById('issue-submit-btn');
            
            if (username.length > 0) {
                try {
                    const response = await fetch(`/admin/validate-member/${username}`);
                    const data = await response.json();
                    
                    if (data.exists) {
                        validationDiv.textContent = '‚úì Valid username';
                        validationDiv.className = 'validation-message valid';
                        selectedMemberInfo.innerHTML = `
                            <div class="member-details">
                                <div><strong>${data.member.fullname}</strong></div>
                                <div>${data.member.email}</div>
                            </div>
                        `;
                        validateForm();
                    } else {
                        validationDiv.textContent = '‚úó Username not found';
                        validationDiv.className = 'validation-message invalid';
                        selectedMemberInfo.innerHTML = '';
                        submitBtn.disabled = true;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    validationDiv.textContent = 'Error validating username';
                    validationDiv.className = 'validation-message invalid';
                    submitBtn.disabled = true;
                }
            } else {
                validationDiv.textContent = '';
                selectedMemberInfo.innerHTML = '';
                submitBtn.disabled = true;
            }
        });

        // Book code validation
        document.getElementById('book-code-input').addEventListener('input', async function(e) {
            const bookCode = this.value.trim();
            const validationDiv = document.getElementById('book-validation');
            const selectedBookInfo = document.querySelector('#selected-book .selected-info');
            const submitBtn = document.getElementById('issue-submit-btn');
            
            if (bookCode.length > 0) {
                try {
                    const response = await fetch(`/admin/validate-book/${bookCode}`);
                    const data = await response.json();
                    
                    if (data.exists && data.available > 0) {
                        validationDiv.textContent = '‚úì Book available';
                        validationDiv.className = 'validation-message valid';
                        selectedBookInfo.innerHTML = `
                            <div class="book-details">
                                <div><strong>${data.book.title}</strong></div>
                                <div>Available: ${data.book.available}/${data.book.quantity}</div>
                            </div>
                        `;
                        validateForm();
                    } else if (data.exists) {
                        validationDiv.textContent = '‚úó Book not available';
                        validationDiv.className = 'validation-message invalid';
                        selectedBookInfo.innerHTML = '';
                        submitBtn.disabled = true;
                    } else {
                        validationDiv.textContent = '‚úó Book code not found';
                        validationDiv.className = 'validation-message invalid';
                        selectedBookInfo.innerHTML = '';
                        submitBtn.disabled = true;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    validationDiv.textContent = 'Error validating book code';
                    validationDiv.className = 'validation-message invalid';
                    submitBtn.disabled = true;
                }
            } else {
                validationDiv.textContent = '';
                selectedBookInfo.innerHTML = '';
                submitBtn.disabled = true;
            }
        });

        function validateForm() {
            const username = document.getElementById('member-username').value.trim();
            const bookCode = document.getElementById('book-code-input').value.trim();
            const dueDate = document.getElementById('due-date').value;
            const submitBtn = document.getElementById('issue-submit-btn');
            
            const usernameValid = document.querySelector('#username-validation.valid');
            const bookValid = document.querySelector('#book-validation.valid');
            
            submitBtn.disabled = !(usernameValid && bookValid && dueDate);
        }

        document.getElementById('due-date').addEventListener('change', validateForm);

        // Update the current date/time every second
        setInterval(updateDateTime, 1000);

        // Initialize the date/time when the modal opens
        document.querySelector('.issue-btn').addEventListener('click', () => {
            updateDateTime();
            document.getElementById('issueForm').reset();
            document.getElementById('username-validation').textContent = '';
            document.getElementById('book-validation').textContent = '';
            document.querySelector('#selected-member .selected-info').innerHTML = '';
            document.querySelector('#selected-book .selected-info').innerHTML = '';
            document.getElementById('issue-submit-btn').disabled = true;
        });

        async function searchMembers() {
            const query = document.getElementById("memberSearch").value;
            const res = await fetch(`/search_member?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            const list = document.getElementById("memberList");
            list.innerHTML = "";
            data.results.forEach(item => {
                const opt = document.createElement("option");
                opt.value = item.id;
                opt.textContent = `${item.fullname} (ID: ${item.id})`;
                list.appendChild(opt);
            });
        }

        async function searchBooks() {
            const query = document.getElementById("bookSearch").value;
            const res = await fetch(`/search_book?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            const list = document.getElementById("bookList");
            list.innerHTML = "";
            data.results.forEach(item => {
                const opt = document.createElement("option");
                opt.value = item.id;
                opt.textContent = `${item.title} (ID: ${item.id})`;
                list.appendChild(opt);
            });
        }

        // Show modal on button click
        document.querySelector('.issue-btn').addEventListener('click', function() {
            document.getElementById('issueModalSimple').style.display = 'block';
        });
    </script>
</body>
</html>
